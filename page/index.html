<!DOCTYPE html>
<html lang="en" style="height: 100%">
<head>
    <meta charset="UTF-8">
    <title>è·¯ä¹¦</title>
    <style>
        #container {width:100%; }
        /*å³é”®æ ·å¼ start */
        .my_context_menu{
            position: relative;
            min-width: 12rem;
            background-color: aliceblue;
            width: 80px;
            padding: 0;
        }
        .my_context_menu .context_menu_sub{
            cursor: pointer;
            height: 30px;
            line-height: 30px;
            padding-left: 8px;
            font-size: 12px;
            border: 1px solid #ddd;
            font-weight: bold;
        }
        .my_context_menu .context_menu_sub.danger{
            color: red;
            font-weight: bolder;
        }
        .my_context_menu div:hover{
            background: #9eccc5;
        }
        /*å³é”®æ ·å¼ end */

        .nopadding{
            padding: 0!important;
        }
        .paddingLeft5{
            padding: 12px 5px !important;
        }
        .card-body p{
            margin: 0!important;
        }
        .header-total-span{
            font-size: 20px;font-weight: bolder;color: red;
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
</head>
<body style="height: 100%">
<div class="container-fluid" style="height: 50px;text-align: left;line-height: 50px;">
    <div class="row">
        <div class="nopadding col-lg-1">
            <div><span style="font-size: 40px">è·¯ä¹¦</span></div>
        </div>
        <div class="col-lg-11">
            <div class="container">
                <div class="row">
                    <div class="col-sm-3">
                        <div class="input-group input-group-sm mb-3" style="margin-top: 10px;max-width: 250px;">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="inputGroup-sizing-sm">æŸ¥è¯¢å†…å®¹</span>
                            </div>
                            <input type="text" id="searchInput" class="form-control" placeholder="è¯·è¾“å…¥è¦æŸ¥è¯¢çš„å†…å®¹" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm">
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" onclick="searchPlace()">æŸ¥è¯¢</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-2">
                        <div class="input-group input-group-sm mb-3" style="margin-top: 10px;">
                            <div class="input-group-prepend">
                                <span class="input-group-text" >æ²¹ä»·</span>
                            </div>
                            <input type="number" id="oilPrice" class="form-control" placeholder="æˆå“æ²¹å•ä»·" >
                            <div class="input-group-append">
                                <span class="input-group-text" >å…ƒ/L</span>
                            </div>
                        </div>
                    </div>

                <div class="col-sm-2">
                    <div class="input-group input-group-sm mb-3" style="margin-top: 10px;">
                        <div class="input-group-prepend">
                            <span class="input-group-text">æ²¹è€—</span>
                        </div>
                        <input type="number" id="oilUsePre" class="form-control" placeholder="ç™¾å…¬é‡Œæ²¹è€—" title="L/ç™¾å…¬é‡Œ">
                        <div class="input-group-append">
                            <span class="input-group-text" title="L/ç™¾å…¬é‡Œ">L</span></div>
                    </div>
                </div>
                    <div class="col-sm-5">
                        <div class="input-group input-group-sm mb-3" style="margin: 0px;">
                            é¢„è®¡æ²¹è´¹<span class="header-total-span" id="totalOilPrice">0</span>å…ƒ
                            &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;
                            é«˜é€Ÿè·ç¦»<span class="header-total-span" id="totalHighRoadLength">0</span>å…¬é‡Œï¼Œé¢„è®¡æ¶ˆè´¹<span class="header-total-span" id="totalHighRoadPrice">0</span>å…ƒ
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="container-fluid">
    <div class="row">
        <div class="nopadding col-lg-9 col-xl-10">
            <div id="container"></div>
        </div>
        <div class="nopadding col-lg-3 col-xl-2" id="right" style="overflow-y: auto;">
        </div>
    </div>
</div>
</body>
<script type="text/javascript" src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
<script type="text/javascript" src="https://webapi.amap.com/maps?v=1.4.15&key=b9e85f9860d919f04446258186ac3e2f"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
<script>
    var height = window.innerHeight - 60;
    $('#container').height(height);
    $('#right').height(height);
    var map = new AMap.Map('container', {
        zoom:11,//çº§åˆ«
        viewMode:'2D',
        mapStyle:"amap://styles/macaron",
        resizeEnable: true,
        keyboardEnable: false
    });

    var searchPlace = function () {
      var input = $('#searchInput').val();
        console.log(123123,input);
      if(!!input){
          AMap.plugin(['AMap.Autocomplete',"AMap.PlaceSearch"], function() {
              var autoOptions = {
                  // ä½¿ç”¨è”æƒ³è¾“å…¥çš„inputçš„id
                  input: "input"
              }
              var autocomplete= new AMap.Autocomplete(autoOptions);
              //æ„é€ åœ°ç‚¹æŸ¥è¯¢ç±»
              var placeSearch = new AMap.PlaceSearch({
                  pageSize: 5, // å•é¡µæ˜¾ç¤ºç»“æœæ¡æ•°
                  pageIndex: 1, // é¡µç 
                  map: map, // å±•ç°ç»“æœçš„åœ°å›¾å®ä¾‹
                  panel: "panel", // ç»“æœåˆ—è¡¨å°†åœ¨æ­¤å®¹å™¨ä¸­è¿›è¡Œå±•ç¤ºã€‚
                  autoFitView: true // æ˜¯å¦è‡ªåŠ¨è°ƒæ•´åœ°å›¾è§†é‡ä½¿ç»˜åˆ¶çš„ Markerç‚¹éƒ½å¤„äºè§†å£çš„å¯è§èŒƒå›´
              });
              //å…³é”®å­—æŸ¥è¯¢
              AMap.event.addListener(autocomplete, 'select', function(e){
                  placeSearch.search(e.poi.name)
              })
          });
      }else{
          alert("æ»šğŸ˜¡");
      }
    };

    // èœå•å†…å®¹
    var contentMenuDev = [
        '<div class="my_context_menu">',
        '<div class="context_menu_sub" onclick="map.zoomOut()">ç¼©å°</div>',
        '<div class="context_menu_sub" onclick="map.zoomIn()">æ”¾å¤§</div>',
        '<div class="context_menu_sub" onclick="menu.addMarkerMenu()">Mark</div>',
        '<div class="context_menu_sub danger" onclick="map.zoomIn()">æ¸…ç©ºæ‰€æœ‰</div>',
        '</div>'
    ];
    var menu = new AMap.ContextMenu({
        content: contentMenuDev.join('')
    });
    var menuProto = menu.prototype?menu.prototype:menu.__proto__;
    menuProto.addMarkerMenu = function () {
        var position = this.position;
        if(rightStorage.markers.length>99){
            alert("è¯¶æˆ‘è‰äº†ï¼Œç‚¹å¤ªå¤šäº†ï¼Œç”µè„‘å—ä¸äº†");
            return ;
        }
        var eachMarker = {
            marker:undefined,
            position:position
        };
        AMap.plugin(['AMap.Geocoder','AMap.Driving'],function(){//å¼‚æ­¥åŠ è½½æ’ä»¶

            var index = rightStorage.markers.length;
            var marker = new AMap.Marker({
                map: map,
                title:'ç¬¬'+index+'ç‚¹ä½',
                position: position //åŸºç‚¹ä½ç½®
            });
            eachMarker['marker'] = marker;
            var plus = new AMap.Geocoder();
            plus.getAddress(position,function (status,res) {
                if(status === 'complete'){
                    eachMarker["index"] = index;
                    eachMarker["address"] = res.regeocode.formattedAddress;
                    eachMarker["addressInfos"] = res.regeocode.addressComponent;
                    if(index>0){
                        var preMarker = rightStorage.markers[index-1];
                        var driverPlus = new AMap.Driving({map:map});
                        console.log(preMarker.position, eachMarker.position);
                        driverPlus.search(preMarker.position, eachMarker.position, function(status, result) {
                            // result å³æ˜¯å¯¹åº”çš„é©¾è½¦å¯¼èˆªä¿¡æ¯ï¼Œç›¸å…³æ•°æ®ç»“æ„æ–‡æ¡£è¯·å‚è€ƒ  https://lbs.amap.com/api/javascript-api/reference/route-search#m_DrivingResult
                            if (status === 'complete') {
                                console.log(result);
                                eachMarker['routes'] = result.routes;
                            } else {
                                alert('è·å–é©¾è½¦æ•°æ®å¤±è´¥ï¼š' + result)
                            }
                            rightStorage.markers.push(eachMarker);
                            reloadRight();
                        });
                    }else{
                        rightStorage.markers.push(eachMarker);
                        reloadRight();
                    }
                }
            });
        });
        this.close();
    };
    map.on('rightclick', function(e) {
        menu.open(map, e.lnglat);
        menuProto.position = e.lnglat;
    });


    //å³ä¾§åˆ·æ–°
    var rightStorage = {
        markers:[]
    };
    var reloadRight = function () {
        $('#right').empty();
        var totalLength = 0;
        var totalTime = 0;
        var highRoadLength = 0;
        var highRoadPrice = 0;
        for(var i=1;i<rightStorage.markers.length;i++){
            var eachMarker = rightStorage.markers[i];
            console.log(eachMarker);
            var card = $('<div class="card"></div>');
            var header = $('<div class="card-header paddingLeft5"></div>');
            var body = $('<div class="card-body" style="font-size: 12px;"></div>');
            var defaultHeaderIndex = "ã€Œ"+(i)+"ã€";
            var bodyInfo = "";
            if(i==0) {
                defaultHeaderIndex = "ã€Œèµ·ã€";
            }else if(i==rightStorage.markers.length-1){
                defaultHeaderIndex = "ã€Œç»ˆã€";
            }
            var routes = "";
            if(eachMarker.routes){
                var currentRoute = eachMarker.routes[0];
                if(currentRoute.distance){
                    totalLength = totalLength + currentRoute.distance;
                    routes = routes + transformLength(currentRoute.distance);
                }
                if(currentRoute.time){
                    totalTime = totalTime + currentRoute.time;
                    routes = routes + transformTime(currentRoute.time);
                }
                if(currentRoute.tolls_distance){
                    highRoadLength = highRoadLength + currentRoute.tolls_distance;
                    highRoadPrice = highRoadPrice + transformLength(currentRoute.tolls);
                }
            }

            if(i>0){
                body.append("<p>ä»ï¼š"+rightStorage.markers[i-1].address+"</p>")
                    .append("<p>åˆ°ï¼š"+eachMarker.address+"</p>");
                if(eachMarker.routes){
                    var currentRoute = eachMarker.routes[0];
                    if(currentRoute.restrictio==1){
                        body.append("<p>å­˜åœ¨é™è¡Œé“è·¯æ— æ³•è§„é¿ï¼Œè¯·æ³¨æ„ï¼</p>")
                    }
                    if(currentRoute.tolls_distance > 0){
                        body.append("<p>æ”¶è´¹è·¯æ®µé•¿"+transformLength(currentRoute.tolls_distance)+" æ”¶è´¹é‡‘é¢"+currentRoute.tolls+"å…ƒ</p>")
                            .append("<p>é©¾è½¦è§„åˆ’ç­–ç•¥"+currentRoute.policy+"</p>");
                    }
                    if(currentRoute.steps){
                        var stepDiv = $('<div style="max-height: 100px;overflow-y: auto;border: 1px dotted cornflowerblue"></div>');
                        for(var j=0;j<currentRoute.steps.length;j++){
                            stepDiv.append('<p">'+currentRoute.steps[j].instruction+'</p>');
                        }
                        body.append(stepDiv);
                    }
                }
            }
            $(header).text(defaultHeaderIndex+routes);
            $('#right').append(card.append(header).append(body))
        }

        var total = $('<div class="alert alert-success" role="alert"></div>');
        var totalInfo = "æ€»è·ç¦»ï¼š";
        if(totalLength>0){
            totalInfo = totalInfo+transformLength(totalLength)+"  é¢„è®¡è€—æ—¶:"+transformTime(totalTime);
        }else{
            totalInfo = totalInfo+"0ç±³"
        }
        total.text(totalInfo);
        $('#right').append(total);

        //æ€»æ²¹è´¹
        var oilPrice = $('#oilUsePre').val();
        var oilUsePre = $('#oilUsePre').val();
        $('#totalOilPrice').text(oilUsePre*oilPrice*(totalLength/100000).toFixed(2));
        //é«˜é€Ÿé•¿åº¦
        $('#totalHighRoadLength').text(highRoadLength);
        //é«˜é€Ÿæ¶ˆè´¹
        $('#totalHighRoadPrice').text(highRoadPrice);
    }

    //è®¡ç®—æ—¶é—´
    var transformTime = function (target) {
        var result = "";
        var hour = parseInt(target/(60*60));
        var min = parseInt(target/60)+1;
        if(hour>0){
            result+=(hour+"h");
        }
        if(min>0){
            result+=(min+"m");
        }
        return result;
    };

    //è®¡ç®—è·ç¦»
    var transformLength = function (target) {
        var result = "";
        var km = parseInt(target/1000);
        var m = target%1000;
        if(km>0){
            result+=(km+"å…¬é‡Œ");
        }
        if(m>0){
            result+=(m+"ç±³");
        }
        return result;
    };

</script>
</html>